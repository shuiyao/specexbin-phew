# SPECEXBIN:

Generate mock line of sight (LoS) quasar absorption spectra from cosmological simulations. It is made compatible with the GIZMO code + PhEW model. It contains AUTOVP, a software that analyzes the spectra data and perform profile fitting.

See README for the detailed manual from the original author, Benjamin D. Oppenheimer.

## Files and Parameters

Here is a list of user defined files and parameters that you might need to reconfigure on a different machine.

_./specions_i9_gizmo.dat_: The ions data, including atomic weight, solar mass fraction, corresponding column in the P.Metallicity field in the simulation. By default, the GIZMO HDF5 output has 11 metallicity fields, i.e., Z, He, C, N, O, Ne, Mg, Si, S, Ca, Fe. Adjust the 6th column of the table accordingly.

_./Makefile_:
  - SHORTSPEC: Turn on to enable shortLoS, otherwise generate random LoS

_./specexbindefs.h_:
  - FOLDER_IONS: The folder that contains data tables that are necessary. Make sure these files are already on the computer.
  - FOLDER_OUTPUT: The default output folder. Since thousands of files will be dumped into this folder. We better choose a "dump site" that is exclusively used for temporarily storing the data.

_./contspecexbin.c_:
  - The cosmological parameters are hardcoded in and should be adjusted accordingly. The default values are Omega_m = 0.30, Omega_Lambda = 0.7, Omega_baryon = 0.045, H_0 = 70.

_./SCRIPT/angles_: The angle files, used for batch generating random LoS

_./SCRIPT/tabs_: The files that point to the locations of the snapshots from the simulation.

_./SCRIPT/LoS_: The targeted LoS (with SHORTSPEC) that was generated.

## Generate Random LoS with SPECEXBIN

Suppose now we want to generate random LoS for a simulation named $modelname.

### Example:

Here is an example script that can be found at SCRIPT/example.sh. This script will generate 2 random sightlines at two different angles from z = 0.0 to z = 0.5. It reads the snapshots specified in SCRIPT/tab/l50n288-phew-m4.tab and will write two files with prefix "specztauw." in the FOLDER_OUTPUT (if OUTPUT_LOCAL_FOLDER is OFF) or in the current folder. The format of the output files is described in README.

```
#!/bin/bash
# This is an example script for generating a couple of random LoS.

# In the Makefile, make sure these options are turned OFF:
# - PHEW
# - SHORTSPEC

modelname=l50n288-phew-m4 # THe model name
zbeg=0.0 # The Starting redshift of the LoS
zend=0.5 # The Ending redshift of the LoS
lbox=50.0 # The boxsize in units of [Mpc/h]
ftau=1.0 # Boost factor for the UV background.
tabfile="tabs/"$modelname # The file that specifies which snapshots to use and their locations

while read line 
do
    echo "../contspecexbin "$modelname $zbeg $zend $lbox $ftau $line
    ../contspecexbin $tabfile $zbeg $zend $lbox $ftau $line
done < "angles/angles_sample.dat"
# The angles_sample.dat is a list of angles that will be passed as an argument in the code.
# Each angle correpsonds to a single random LoS.
```

After SPECEXBIN has generated the outputs, use AUTOVP to fit line profiles and extract information about different ions. Here is an example that can be found at autovp/example.sh. It reads the SPECEXBIN output and generate a number of $ion.vpm files, each contains a list of absorbers with their properties such as N, EW, etc. that lie along the LoS.
```
#!/bin/bash

# Example script for calculating absorption properties from generated spectra.

rm mkspecRAD
gcc -o mkspecRAD -DDO9IONS mkspecRAD.c -lm

sn=30
dvpix=6
dvres=0
ions='OVI MgII CIV'
#ions='HI'

zquasar=0.51 # The redshift of the "imagined" background source, e.g., quasar
taufact=1.0  # Artificially adjust the strength of the UV background

# Use autovp.par.HI for HI and autovp.par.OVI for other ions

cp autovp.par.OVI ./src/autovp.par
#cp autovp.par.HI ./src/autovp.par 

f="/proj/shuiyao/los/specztauw.l25n144-phewoff-pp.10.50_0" # Should be any output file generated by the SPECEXBIN

for ion in `echo $ions`
do
    #mkspecRad
    ./mkspecRAD $f $sn $zquasar $taufact $dvpix $dvres $ion
    cp $ion.raw $ion.cln
    ./autofit $ion
    ./minfit $ion.pro
done    
```

You should now have a number of .vpm files in the autovp/ folder.

Below is MY detailed pipeline for generate many LoS for a given simulation.

1. Preparation
  - In SCRIPT/tabs/, create the shortlos_$modelname.tab file. You can edit from the sample.tab file.
  - Check SHORTSPEC, OUTPUT_LOCAL_FOLDER and specexbindefs.h
  - Generate the .slm files and .sh files for a given model. For example:
  ```
  python create_batch_files.py l25n288 2.0e38
  ```
  - Check the .slm and .sh file, then

2. Run SPECEXBIN with
```
bash batch.sh
```

3. Relocate Output Files
  - The output files are temporarily stored at specexbindefs.h:FOLDER_OUTPUT
  - 

4. (PhEW only, now part of 5) Add Clouds to the Spectra
In the autovp folder, use
```
python add_clouds_to_spec.py $modelname
```

5. Do AutoVP
In the root folder of the SPECEXBIN:
```
cd autovp
bash dospectra.sh
```

6. Compile VPM files
  - spec_compile.py and spec_compile_HI.py

## Generate ShortLOS with SPECEXBIN.

1. Generate LoS info
  - mklosfile.py
    - Purpose: Create LoS data in LoS/ [A]
    - Parameters: modelname, MASSBIN=12, NHALO=250
  - In tabs/, create the shortlos_$modelname.tab file [B]
2. Specexbin
  - Compile with SHORTSPEC, check OUTPUT_LOCAL_FOLDER and specexbindefs.h
  - shortlos.slm -> batch_shortlos.sh
    - Specify modelname, mcinit, lbox. Takes [A], [B] as input
    - By default, output in /proj/shuiyao/los/shortlos/temp
3. Distribute specaim files
  - distributeLOS.sh
    - Calls createlosfolder.sh
    - Calls distributeLOS.py
      - Create a $modelname.page file [C]
    - move files from /proj/shuiyao/los/shortlos/temp to distinations according to [C]
4. Copy autovp/ and autovpHI/ to $modelname folder
5. (PhEW only) Add clouds to the spectra
  - autovp/add_clouds_to_spec.py
6. AutoVP
  - Use dospectra.sh
7. Compile VPM files
  - spec_compile.py and spec_compile_HI.py
